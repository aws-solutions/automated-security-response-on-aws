# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
# SPDX-License-Identifier: Apache-2.0
---
description: |
  ### Document Name - ASR-EnableCloudTrailToCloudWatchLogging
  ## What does this document do?
  Enables CloudTrail logging to CloudWatch Logs by:
  1. Creating or reusing an existing CloudWatch log group
  2. Fixing S3 bucket policy with required SourceArn condition for security
  3. Updating the CloudTrail to send logs to CloudWatch

  This fixes the common "InsufficientS3BucketPolicyException" error by ensuring
  the S3 bucket policy includes the AWS:SourceArn condition required by AWS.

  ## Input Parameters
  * AutomationAssumeRole: (Required) The ARN of the role that allows Automation to perform the actions on your behalf.
  * TrailName: (Required) The name of the CloudTrail to enable logging for.
  * CloudWatchLogsRole: (Required) The ARN of the role that allows CloudTrail to log to CloudWatch.
  * LogGroupName: (Required) The name of the CloudWatch Log Group for CloudTrail logs.

  ## Security Standards / Controls
  * AWS FSBP v1.0.0:   N/A
  * CIS v1.2.0:        2.4
  * PCI:               CloudTrail.4

schemaVersion: "0.3"
assumeRole: "{{ AutomationAssumeRole }}"
parameters:
  AutomationAssumeRole:
    type: String
    description: (Required) The ARN of the role that allows Automation to perform the actions on your behalf.
    allowedPattern: '^arn:(?:aws|aws-us-gov|aws-cn):iam::\d{12}:role/[\w+=,.@-]+$'
  TrailName:
    type: String
    description: (Required) The name of the CloudTrail.
    allowedPattern: '^[A-Za-z0-9._-]{3,128}$'
  CloudWatchLogsRole:
    type: String
    description: (Required) The ARN of the role that allows CloudTrail to log to CloudWatch.
    allowedPattern: '^arn:(?:aws|aws-us-gov|aws-cn):iam::\d{12}:role/[\w+=,.@-]+$'
  LogGroupName:
    type: String
    description: (Required) The name of the Log Group for CloudTrail logs.
    allowedPattern: '^[a-zA-Z0-9-_./]{1,512}$'
outputs:
  - UpdateTrailToCWLogs.Output
  - FixCloudTrailBucketPolicy.BucketPolicyResult
  - ValidateBucketPolicy.ValidationResult

mainSteps:
  -
    name: CreateOrGetLogGroup
    action: 'aws:executeScript'
    inputs:
      InputPayload:
        LogGroup: '{{LogGroupName}}'
      Runtime: python3.11
      Handler: create_or_get_loggroup
      Script: |-
        %%SCRIPT=EnableCloudTrailToCloudWatchLogging_waitforloggroup.py%%
    outputs:
      - Name: CloudWatchLogsGroupArn
        Selector: $.Payload
        Type: String
    description: Create log group if it doesn't exist, or get existing log group ARN

  -
    name: FixCloudTrailBucketPolicy
    action: 'aws:executeScript'
    inputs:
      InputPayload:
        trail_name: '{{TrailName}}'
        partition: '{{global:AWS_PARTITION}}'
        account: '{{global:ACCOUNT_ID}}'
      Runtime: python3.11
      Handler: fix_cloudtrail_bucket_policy_for_logging
      Script: |-
        %%SCRIPT=EnableCloudTrailToCloudWatchLogging_fixbucketpolicy.py%%
    description: Fix S3 bucket policy to allow CloudTrail access with SourceArn condition
    outputs:
      - Name: BucketPolicyResult
        Selector: $.Payload.output
        Type: StringMap

  -
    name: ValidateBucketPolicy
    action: 'aws:executeScript'
    inputs:
      InputPayload:
        trail_name: '{{TrailName}}'
        partition: '{{global:AWS_PARTITION}}'
        account: '{{global:ACCOUNT_ID}}'
      Runtime: python3.11
      Handler: validate_cloudtrail_bucket_policy
      Script: |-
        %%SCRIPT=EnableCloudTrailToCloudWatchLogging_validatepolicy.py%%
    description: Validate that S3 bucket policy is correctly configured for CloudTrail
    outputs:
      - Name: ValidationResult
        Selector: $.Payload.output
        Type: StringMap

  -
    name: UpdateTrailToCWLogs
    action: 'aws:executeScript'
    inputs:
      InputPayload:
        trail_name: '{{TrailName}}'
        log_group_arn: '{{CreateOrGetLogGroup.CloudWatchLogsGroupArn}}'
        cloudwatch_role_arn: '{{CloudWatchLogsRole}}'
        validation_result: '{{ValidateBucketPolicy.ValidationResult}}'
      Runtime: python3.11
      Handler: update_trail_with_error_handling
      Script: |-
        %%SCRIPT=EnableCloudTrailToCloudWatchLogging_updatetrail.py%%
    description: Enable logging to CloudWatch Logs with enhanced error handling
    outputs:
      - Name: Output
        Selector: $.Payload.output
        Type: StringMap
