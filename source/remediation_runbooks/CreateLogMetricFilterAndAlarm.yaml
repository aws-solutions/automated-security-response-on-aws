# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
# SPDX-License-Identifier: Apache-2.0
---
description: |
  ### Document Name - ASR-CreateLogMetricFilterAndAlarm
  ## What does this document do?
  Creates a CloudWatch metric filter and alarm for log monitoring by:
  1. Creating an encrypted SNS topic for alarm notifications
  2. Ensuring the specified log group exists (creates if missing)
  3. Creating a metric filter on the log group with the specified pattern
  4. Creating a CloudWatch alarm that triggers when the metric threshold is exceeded

  This runbook is commonly used for security monitoring (e.g., failed login attempts,
  unauthorized API calls, etc.) as required by various compliance standards.

  ## Input Parameters
  * AutomationAssumeRole: (Required) The ARN of the role that allows Automation to perform the actions on your behalf.
  * LogGroupName: (Required) Name of the CloudWatch log group to monitor
  * FilterName: (Required) Name for the metric filter
  * FilterPattern: (Required) Log filter pattern to match events
  * MetricName: (Required) Name of the CloudWatch metric
  * MetricNamespace: (Required) Namespace for the metric
  * MetricValue: (Required) Value to record when pattern matches
  * AlarmName: (Required) Name for the CloudWatch alarm
  * AlarmDesc: (Required) Description for the alarm
  * AlarmThreshold: (Required) Threshold value that triggers the alarm
  * SNSTopicName: (Required) Name for the SNS topic for notifications
  * KMSKeyArn: (Required) KMS key ARN for encrypting the SNS topic

  ## Security Standards / Controls
  * CIS v1.2.0:     3.1-3.14
schemaVersion: '0.3'
assumeRole: "{{ AutomationAssumeRole }}"
parameters:
  AutomationAssumeRole:
    type: String
    description: (Required) The ARN of the role that allows Automation to perform the actions on your behalf.
    allowedPattern: '^arn:(?:aws|aws-us-gov|aws-cn):iam::\d{12}:role/[\w+=,.@-]+$'
  LogGroupName:
    type: String
    description: Name of the log group to be used to create metric filter
    allowedPattern: '.*'
  FilterName:
    type: String
    description: Name for the metric filter
    allowedPattern: '.*'
  FilterPattern:
    type: String
    description: Filter pattern to create metric filter
    allowedPattern: '.*'
  MetricName:
    type: String
    description: Name of the metric for metric filter
    allowedPattern: '.*'
  MetricValue:
    type: Integer
    description: Value of the metric for metric filter
  MetricNamespace:
    type: String
    description: Namespace where the metrics will be sent
    allowedPattern: '.*'
  AlarmName:
    type: String
    description: Name of the Alarm to be created for the metric filter
    allowedPattern: '.*'
  AlarmDesc:
    type: String
    description: Description of the Alarm to be created for the metric filter
    allowedPattern: '.*'
  AlarmThreshold:
    type: Integer
    description: Threshold value for the alarm
  KMSKeyArn:
    type: String
    description: The ARN of a KMS key to use for encryption of the SNS Topic and Config bucket
    allowedPattern: '^arn:(?:aws|aws-us-gov|aws-cn):kms:(?:[a-z]{2}(?:-gov)?-[a-z]+-\d):\d{12}:(?:(?:^(alias/)[a-zA-Z0-9:/_-]+$)|(?:key/(?i:[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12})))$'
  SNSTopicName:
    type: String
    allowedPattern: ^[a-zA-Z0-9][a-zA-Z0-9-_]{0,255}$

outputs:
  - CreateMetricFilerAndAlarm.Output
  - CreateTopic.TopicArn

mainSteps:
  -
    name: CreateTopic
    action: 'aws:executeScript'
    outputs:
      - Name: TopicArn
        Selector: $.Payload.topic_arn
        Type: String
    inputs:
      InputPayload:
        kms_key_arn: '{{KMSKeyArn}}'
        topic_name: '{{SNSTopicName}}'
      Runtime: python3.11
      Handler: create_encrypted_topic
      Script: |-
        %%SCRIPT=CreateLogMetricFilterAndAlarm_createtopic.py%%

  -
    name: CreateMetricFilerAndAlarm
    action: 'aws:executeScript'
    outputs:
      - Name: Output
        Selector: $.Payload.response
        Type: StringMap
    inputs:
      InputPayload:
        LogGroupName: '{{LogGroupName}}'
        FilterName: '{{FilterName}}'
        FilterPattern: '{{FilterPattern}}'
        MetricName: '{{MetricName}}'
        MetricNamespace: '{{MetricNamespace}}'
        MetricValue: '{{MetricValue}}'
        AlarmName: '{{AlarmName}}'
        AlarmDesc: '{{AlarmDesc}}'
        AlarmThreshold: '{{AlarmThreshold}}'
        TopicArn: '{{CreateTopic.TopicArn}}'
      Runtime: python3.11
      Handler: verify
      Script: |-
        %%SCRIPT=CreateLogMetricFilterAndAlarm.py%%
